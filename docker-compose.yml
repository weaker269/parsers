services:
  # Parser gRPC 服务（可通过 --scale 扩展多副本）
  parser-service:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "50051:50051"
    environment:
      # gRPC 服务参数（与 .env.example 对齐）
      - PARSER_GRPC_PORT=${PARSER_GRPC_PORT:-50051}
      - PARSER_GRPC_MAX_WORKERS=${PARSER_GRPC_MAX_WORKERS:-64}
      - PARSER_GRPC_PRELOAD_OCR=${PARSER_GRPC_PRELOAD_OCR:-true}

      # 日志输出配置
      - PARSER_LOG_DIR=${PARSER_LOG_DIR:-./logs}
      - PARSER_LOG_FILE=${PARSER_LOG_FILE:-parser.log}
      - PARSER_LOG_LEVEL=${PARSER_LOG_LEVEL:-INFO}

      # 页面级进程池配置（动态调整并发性能）
      - PARSER_PAGE_POOL_MAX_WORKERS=${PARSER_PAGE_POOL_MAX_WORKERS:-0}
      - PARSER_PAGE_POOL_RESERVED_CORES=${PARSER_PAGE_POOL_RESERVED_CORES:-2}
      - PARSER_PAGE_POOL_MAX_LIMIT=${PARSER_PAGE_POOL_MAX_LIMIT:-32}

      # OCR 进程池配置（动态调整 OCR 引擎进程数）
      - PARSER_OCR_POOL_MAX_WORKERS=${PARSER_OCR_POOL_MAX_WORKERS:-0}
      - PARSER_OCR_POOL_MAX_LIMIT=${PARSER_OCR_POOL_MAX_LIMIT:-5}

      # OCR 并发配置（动态调整 OCR 性能）
      - PARSER_OCR_MAX_CONCURRENT=${PARSER_OCR_MAX_CONCURRENT:-10}
      - PARSER_OCR_TIMEOUT_PER_IMAGE=${PARSER_OCR_TIMEOUT_PER_IMAGE:-180.0}

    deploy:
      resources:
        limits:
          memory: 4G            # 内存限制（提升到 4GB，适应多进程）
          # cpus: '2'           # 已移除 CPU 限制，使用主机所有核心
        reservations:
          memory: 1G            # 内存预留（提升到 1GB）
          # cpus: '1'           # 已移除 CPU 预留

    healthcheck:
      test: ["CMD", "/bin/bash", "/app/parsers/scripts/grpc_health_check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s       # OCR 模型加载需要时间

    restart: unless-stopped

    networks:
      - parser-net

    volumes:
      # 挂载日志目录（可选，用于持久化日志）
      - ./logs:/app/logs

networks:
  parser-net:
    driver: bridge

# ===========================
# 使用说明
# ===========================
#
# 1. 单副本启动：
#    docker-compose up -d
#
# 2. 多副本启动（负载均衡）：
#    docker-compose up -d --scale parser-service=3
#
# 3. 查看服务状态：
#    docker-compose ps
#
# 4. 查看日志：
#    docker-compose logs -f parser-service
#
# 5. 健康检查：
#    docker exec <container_id> ./scripts/grpc_health_check.sh
#
# 6. 停止服务：
#    docker-compose down
#
# 7. 重新构建并启动：
#    docker-compose up -d --build
#
# ===========================
# 环境变量配置
# ===========================
#
# 在项目根目录创建 .env 文件，配置以下变量：
#
# # gRPC 服务参数
# PARSER_GRPC_PORT=50051
# PARSER_GRPC_MAX_WORKERS=64
# PARSER_GRPC_PRELOAD_OCR=true
#
# # gRPC 客户端（可选，本地 CLI/调试脚本使用）
# PARSER_GRPC_HOST=localhost
# PARSER_GRPC_TIMEOUT=600.0
# PARSER_GRPC_MAX_RETRIES=3
#
# # 日志输出配置
# PARSER_LOG_DIR=./logs
# PARSER_LOG_FILE=parser.log
# PARSER_LOG_LEVEL=INFO
